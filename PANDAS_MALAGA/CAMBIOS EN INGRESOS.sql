/* Formatted on 8/22/2014 11:24:47 AM (QP5 v5.163.1008.3004) */
ALTER TABLE TEMP_INGRESOS_A102003 READ WRITE;

UPDATE TEMP_INGRESOS_A102003 A1
   SET NATID_CENTRO_PRIMER_TRASLADO =
          NVL ( (SELECT UBI_CAH_CODIGO
                   FROM UBICACIONES
                  WHERE UBI_CODIGO = A1.NATID_CAMA_PRIMER_TRASLADO),
               -1);

ALTER TABLE TEMP_INGRESOS_A102003 READ ONLY;

SELECT *
  FROM TEMP_INGRESOS_A102003
 WHERE NATID_CENTRO_PRIMER_TRASLADO = -1 AND NATID_CAMA_PRIMER_TRASLADO > 0;

SELECT UBI_CAH_CODIGO
  FROM UBICACIONES
 WHERE UBI_CODIGO = 67744;

/

SELECT NATID_ADMISION, UBIC_TERMINAL
  FROM (SELECT NATID_ADMISION, UBIC_TERMINAL, RANK () OVER (PARTITION BY ADMISION ORDER BY TRASLADO_ID) R
          FROM TEMP_INGRESOS_A102003 JOIN ADM_TRASLADO ON (NATID_ADMISION = ADMISION)
         WHERE TRASLADO_PADRE IS NULL)
 WHERE R = 1
/

  SELECT TRASLADO_ID,
         NATID_ADMISION,
         UBIC_TERMINAL,
         RANK () OVER (PARTITION BY ADMISION ORDER BY TRASLADO_ID) R
    FROM TEMP_INGRESOS_A102003 JOIN REP_HIS_OWN.ADM_TRASLADO@SEE41DAE ON (NATID_ADMISION = ADMISION)
   WHERE TRASLADO_PADRE IS NULL AND NATID_ADMISION IN (1646048, 6677780, 1953225, 1955163, 1961513, 1975408, 1976755, 1986846, 1997705, 2012618, 2069942, 2841750, 2841762, 2920758, 3395731, 4284714, 5884785, 6077740, 1891464)
ORDER BY TRASLADO_ID                                                                                                                                                          -- RANK () OVER (PARTITION BY ADMISION ORDER BY TRASLADO_ID)  DESC
/

SELECT NATID_ADMISION, UBIC_TERMINAL, UBI_CAH_CODIGO
  FROM    (  SELECT NATID_ADMISION, MAX (UBIC_TERMINAL) KEEP (DENSE_RANK FIRST ORDER BY TRASLADO_ID) UBIC_TERMINAL
               FROM TEMP_INGRESOS_A102003 JOIN REP_HIS_OWN.ADM_TRASLADO@SEE41DAE ON (NATID_ADMISION = ADMISION)
           GROUP BY NATID_ADMISION)
       JOIN
          (SELECT UBI_CODIGO, UBI_CAH_CODIGO FROM REP_PRO_EST.UBICACIONES@SEE41DAE)
       ON (UBIC_TERMINAL = UBI_CODIGO)